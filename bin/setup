#!/usr/bin/env bash

__dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
env_file=${__dir}/../.env
env_example_file=${__dir}/../.env.example

function main() {
  set -e

  add_new_env_vars
  add_reaction_user
}

function add_new_env_vars() {
  # create .env and set perms if it does not exist
  if [[ ! -f "${env_file}" ]]; then
    touch "${env_file}"
    chmod 0600 "${env_file}"
  fi

  while IFS=$'\n' read -r var; do
    key="${var%%=*}"        # get var key
    var=$(eval echo "$var") # generate dynamic values

    # If .env doesn't contain this env key, add it
    if ! grep -qLE "^$key=" "${env_file}"; then
      echo "Adding $key to .env"
      echo "$var" >>"${env_file}"
    fi
  done <"${env_example_file}"
}

function add_reaction_user() {
  if grep -qLE "^REACTION_USER" "${env_file}"; then
    # line is already present, leave unchanged
    return
  fi
  # line is not present
  if [[ -n "${REACTION_USER}" ]]; then
    # if set in environment, just add the name but no = and no value
    line="REACTION_USER"
  else
    # if unset in environment, default to the current user's uid:gid
    line="REACTION_USER=$(id -u):$(id -g)"
  fi
  echo "Adding ${line} to .env"
  echo "${line}" >>"${env_file}"
}

main
